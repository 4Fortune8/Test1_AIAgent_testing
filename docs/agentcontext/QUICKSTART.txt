â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAN PING/PONG QUICK START                         â”‚
â”‚                Protocol Decisions Approved âœ“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ FULL DOCUMENTATION
â”œâ”€ ğŸ“„ roadmap_can_ping_pong.md        â† MAIN ROADMAP (read first)
â”œâ”€ â˜‘ï¸  checklist_can_ping_pong.md      â† Implementation tracking
â”œâ”€ âœ… protocol_amendment_pong.md      â† PONG spec (APPROVED)
â”œâ”€ ğŸ“ PLANNING_SUMMARY.md             â† Executive summary
â””â”€ ğŸ”§ protocol/can_invariants.md      â† 15 binding rules (NEW)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  BEFORE ANY CODE: REMAINING APPROVALS

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… 1. PONG Command ID - APPROVED                                â”‚
â”‚     Decision: STATUS class, ID=0x001 â†’ CAN ID=0x111            â”‚
â”‚     Binary: 010 0001 0001 | Hex: 0x111 | Decimal: 273          â”‚
â”‚     Status: COMPLETE (see protocol/can_id_map.md)              â”‚
â”‚                                                                 â”‚
â”‚  âœ… 2. PONG Payload Format - APPROVED                            â”‚
â”‚     Decision: 4 bytes, uint32 sequence counter (little-endian) â”‚
â”‚     Rationale: Duplicate/reboot detection, diagnostics         â”‚
â”‚     Status: COMPLETE (see protocol_amendment_pong.md)          â”‚
â”‚                                                                 â”‚
â”‚  âœ… 3. Hardware Configuration - APPROVED                         â”‚
â”‚     ESP32: ESP32-WROOM-32D + SN65HVD230                        â”‚
â”‚     - CAN TX: GPIO21 (Pin 33)                                  â”‚
â”‚     - CAN RX: GPIO22 (Pin 36)                                  â”‚
â”‚     Pi: Raspberry Pi 3B+ + MCP2515 (SPI)                       â”‚
â”‚     - Interface: can0                                           â”‚
â”‚     Status: COMPLETE                                            â”‚
â”‚                                                                 â”‚
â”‚  âœ… 4. RTT Threshold - APPROVED                                  â”‚
â”‚     Target: <50ms, Max: 100ms                                   â”‚
â”‚     Status: âœ“ APPROVED                                          â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ 5. WIRING REQUIRED - Before Implementation                  â”‚
â”‚     - Wire SN65HVD230 to ESP32 GPIO21/22                       â”‚
â”‚     - Install 120Î© terminators at BOTH ends                    â”‚
â”‚     - Configure Pi /boot/config.txt (MCP2515 overlay)          â”‚
â”‚     Status: â³ ACTION REQUIRED                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š PROTOCOL ENHANCEMENTS (NEW)

âœ… CAN ID Reference Table (protocol/can_id_map.md)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Message  â”‚ Class    â”‚ Node     â”‚ Cmd      â”‚ Full Binary    â”‚ Hex   â”‚ Decimal â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ PING     â”‚ 001      â”‚ 0001     â”‚ 0001     â”‚ 001 0001 0001  â”‚ 0x091 â”‚ 145     â”‚
   â”‚ PONG     â”‚ 010      â”‚ 0001     â”‚ 0001     â”‚ 010 0001 0001  â”‚ 0x111 â”‚ 273     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
âœ… PONG Sequence Counter
   â€¢ Starts at 0 on ESP boot
   â€¢ Increments per PONG (wraps at UINT32_MAX)
   â€¢ Little-endian: LSB in byte 0, MSB in byte 3
   â€¢ Enables: duplicate detection, reboot detection, gap analysis

âœ… CAN Invariants (protocol/can_invariants.md)
   â€¢ 15 binding rules covering real-time, fault tolerance, protocol
   â€¢ ESP must never block on CAN TX/RX
   â€¢ Control loop timing independent of CAN
   â€¢ Pi assumes ESP can disappear anytime
   â€¢ Messages must be idempotent
   â€¢ Node ID validation required

âœ… Single-Node Assertion
   â€¢ ESP ignores PING if Node ID != 0x1
   â€¢ Pi logs ERROR if multiple PONGs per PING
   â€¢ Prevents multi-node phantom success

âœ… CAN Filter Documentation
   â€¢ Filter config documented (disabled during bring-up)
   â€¢ Production: Accept COMMAND+ERROR to ESP32-1
   â€¢ Mask: 0x1F0, Code: 0x090

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ IMPLEMENTATION SEQUENCE (After Approval)

Step 1: CREATE PLANNING DOCUMENTS
   â””â”€ esp/thoughtprocesses/2026-01-22_can-bringup-esp.md
   â””â”€ pi/thoughtprocesses/2026-01-22_can-bringup-pi.md
   â””â”€ protocol/thoughtprocesses/2026-01-22_ping-pong-spec.md
   âš ï¸  WAIT FOR HUMAN REVIEW OF PLANNING DOCS

Step 2: UPDATE PROTOCOL FILES
   â””â”€ protocol/can_id_map.md (add PONG ID)
   â””â”€ protocol/can_payload.md (add PONG payload spec)

Step 3: ESP IMPLEMENTATION (Phases 3.1-3.5)
   3.1 â”œâ”€ TWAI driver initialization
   3.2 â”œâ”€ CAN RX task on Core 1
   3.3 â”œâ”€ PING handler (logging only)
   3.4 â”œâ”€ PONG transmission
   3.5 â””â”€ Error handling & robustness

Step 4: PI IMPLEMENTATION (Phases 4.1-4.5)
   4.1 â”œâ”€ SocketCAN interface configuration
   4.2 â”œâ”€ Python CAN library setup
   4.3 â”œâ”€ PING transmission
   4.4 â”œâ”€ PONG reception
   4.5 â””â”€ Error handling & robustness

Step 5: TESTING & VALIDATION
   â””â”€ Run all 8 tests (see roadmap Section 5.2)
   â””â”€ 24-hour stability test REQUIRED

Step 6: VERIFY EXIT CRITERIA
   â””â”€ >99% success rate
   â””â”€ RTT <50ms average
   â””â”€ No crashes/leaks
   â””â”€ Error recovery works
   â””â”€ Core isolation verified

Step 7: UPDATE DOCUMENTATION
   â””â”€ docs/agentcontext/version_log.md
   â””â”€ Add version tags to all code

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ›¡ï¸  HARD RULES (AGENTS.md)

âœ“ ESP Core 0 = control loop ONLY (UNTOUCHABLE)
âœ“ CAN RX/TX = ESP Core 1 ONLY
âœ“ NO blocking calls on ESP
âœ“ NO real-time logic on Pi
âœ“ NO protocol format changes (only additions)
âœ“ NO architectural refactors
âœ“ Planning docs BEFORE code
âœ“ Version tags on ALL code changes

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š EXIT CRITERIA CHECKLIST

Communication:
  [ ] >99% success over 24 hours
  [ ] RTT <50ms avg, <100ms p99
  [ ] No memory leaks
  [ ] No crashes/panics

Error Handling:
  [ ] ESP bus-off recovery works
  [ ] Pi interface restart recovery works
  [ ] Cable disconnect handled
  [ ] Invalid messages ignored

Core Isolation:
  [ ] Core 0 uninterrupted during CAN
  [ ] Core 1 affinity verified
  [ ] No blocking calls (audited)

Documentation:
  [ ] Planning docs complete
  [ ] Code comments with version tags
  [ ] version_log.md updated
  [ ] Failure recovery documented

Testing:
  [ ] All 8 tests passed
  [ ] Results archived
  [ ] Known issues documented

Protocol:
  [ ] PONG ID in can_id_map.md
  [ ] CAN ID verified (scope/analyzer)
  [ ] Payloads match spec

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš« OUT OF SCOPE (DO NOT IMPLEMENT)

  âœ— Motor control commands
  âœ— Encoder integration
  âœ— PID loop activation
  âœ— Safety timeouts
  âœ— Telemetry streaming
  âœ— Multi-ESP support
  âœ— CAN filtering optimization
  âœ— OTA updates

  â†’ Each requires separate roadmap

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ QUESTIONS?

  â†’ Read roadmap_can_ping_pong.md Section X
  â†’ Consult AGENTS.md for rules
  â†’ Consult docs/roles.md for boundaries
  â†’ ASK HUMAN before assuming

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ CURRENT STATUS: Planning Complete, Awaiting Human Review

Next: Human reviews protocol_amendment_pong.md and approves PONG ID
